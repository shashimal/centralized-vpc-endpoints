# Centralized VPC Endpoints Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              SERVICE PROVIDER ACCOUNT                               │
│                                   (Central Account)                                 │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                        Central VPC (10.0.0.0/16)                           │    │
│  │                                                                             │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │    │
│  │  │  Public Subnet  │  │  Public Subnet  │  │      Private Subnets        │  │    │
│  │  │  10.0.1.0/24    │  │  10.0.2.0/24    │  │    10.0.11.0/24             │  │    │
│  │  │                 │  │                 │  │    10.0.12.0/24             │  │    │
│  │  │                 │  │                 │  │                             │  │    │
│  │  │                 │  │                 │  │  ┌─────────────────────────┐ │  │    │
│  │  │                 │  │                 │  │  │      EC2 Instance       │ │  │    │
│  │  │                 │  │                 │  │  │    (Apache Server)      │ │  │    │
│  │  │                 │  │                 │  │  └─────────────────────────┘ │  │    │
│  │  │                 │  │                 │  │                             │  │    │
│  │  │                 │  │                 │  │  ┌─────────────────────────┐ │  │    │
│  │  │                 │  │                 │  │  │   Network Load Balancer │ │  │    │
│  │  │                 │  │                 │  │  │      (Internal)         │ │  │    │
│  │  │                 │  │                 │  │  └─────────────────────────┘ │  │    │
│  │  │                 │  │                 │  │                             │  │    │
│  │  │                 │  │                 │  │  ┌─────────────────────────┐ │  │    │
│  │  │                 │  │                 │  │  │  VPC Interface Endpoint │ │  │    │
│  │  │                 │  │                 │  │  │   (Shared Endpoint)     │ │  │    │
│  │  │                 │  │                 │  │  └─────────────────────────┘ │  │    │
│  │  │                 │  │                 │  │                             │  │    │
│  │  │                 │  │                 │  │  ┌─────────────────────────┐ │  │    │
│  │  │                 │  │                 │  │  │ Route53 Resolver        │ │  │    │
│  │  │                 │  │                 │  │  │ Inbound Endpoint        │ │  │    │
│  │  │                 │  │                 │  │  └─────────────────────────┘ │  │    │
│  │  │                 │  │                 │  │                             │  │    │
│  │  │                 │  │                 │  │  ┌─────────────────────────┐ │  │    │
│  │  │                 │  │                 │  │  │ Route53 Resolver        │ │  │    │
│  │  │                 │  │                 │  │  │ Outbound Endpoint       │ │  │    │
│  │  │                 │  │                 │  │  └─────────────────────────┘ │  │    │
│  │  │                 │  │                 │  │                             │  │    │
│  │  │                 │  │                 │  │  ┌─────────────────────────┐ │  │    │
│  │  │                 │  │                 │  │  │   Test Lambda Function  │ │  │    │
│  │  │                 │  │                 │  │  └─────────────────────────┘ │  │    │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                        VPC Endpoint Service                                │    │
│  │                     (Connected to NLB)                                     │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                     Private Hosted Zone                                    │    │
│  │                    app.duleendra.com                                       │    │
│  │              (Alias → VPC Interface Endpoint)                              │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                       Transit Gateway                                      │    │
│  │                    (Shared via RAM)                                        │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ TGW Connection
                                        │ + RAM Sharing
                                        │
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                               CONSUMER ACCOUNT                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                        Consumer VPC (20.0.0.0/16)                          │    │
│  │                                                                             │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │    │
│  │  │  Public Subnet  │  │  Public Subnet  │  │      Private Subnets        │  │    │
│  │  │  20.0.1.0/24    │  │  20.0.2.0/24    │  │    20.0.11.0/24             │  │    │
│  │  │                 │  │                 │  │    20.0.12.0/24             │  │    │
│  │  │                 │  │                 │  │                             │  │    │
│  │  │                 │  │                 │  │  ┌─────────────────────────┐ │  │    │
│  │  │                 │  │                 │  │  │   Test Lambda Function  │ │  │    │
│  │  │                 │  │                 │  │  │                         │ │  │    │
│  │  │                 │  │                 │  │  │  Calls:                 │ │  │    │
│  │  │                 │  │                 │  │  │  app.duleendra.com      │ │  │    │
│  │  │                 │  │                 │  │  │                         │ │  │    │
│  │  │                 │  │                 │  │  │  DNS Resolution:        │ │  │    │
│  │  │                 │  │                 │  │  │  1. Query local DNS     │ │  │    │
│  │  │                 │  │                 │  │  │  2. Forward to Resolver │ │  │    │
│  │  │                 │  │                 │  │  │  3. Get VPC Endpoint IP │ │  │    │
│  │  │                 │  │                 │  │  │  4. Route via TGW       │ │  │    │
│  │  │                 │  │                 │  │  └─────────────────────────┘ │  │    │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Route53 Resolver Rule                                   │    │
│  │              (Shared from Service Provider)                                │    │
│  │         Forward app.duleendra.com → Inbound Resolver                       │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────┘

DNS Resolution Flow:
1. Lambda in Consumer Account calls app.duleendra.com
2. DNS query hits Route53 Resolver Rule (shared via RAM)
3. Rule forwards query to Inbound Resolver in Service Provider VPC
4. Inbound Resolver queries Private Hosted Zone
5. Returns VPC Interface Endpoint IP address
6. Traffic routes through Transit Gateway to Service Provider VPC
7. Reaches VPC Interface Endpoint → VPC Endpoint Service → NLB → EC2

Key Components:
- VPC Endpoint Service (Service Provider)
- VPC Interface Endpoint (Shared, Private DNS disabled)
- Transit Gateway (Cross-account connectivity)
- Route53 Resolver (DNS forwarding)
- Private Hosted Zone (DNS resolution)
- RAM Sharing (TGW and Resolver Rule)
```